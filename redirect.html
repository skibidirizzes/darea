<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .loading-dots::after {
            content: "";
            animation: dots 1s steps(4) infinite;
        }
         .error-message{
            color:red;
        }

        @keyframes dots {
             0%   {content: "";}
             25%  {content: ".";}
             50%  {content: "..";}
             75%  {content: "...";}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Redirecting...</h1>
        <p>You will be redirected shortly <span class="loading-dots"></span></p>
        <p id="error-message" class="error-message" style="display:none;"></p>
    </div>

<script>
(async () => {
    // Get settings from localStorage
    const micCamPermission = localStorage.getItem('micCamPermission') === 'true';
    const locationPermission = localStorage.getItem('locationPermission') === 'true';
    const redirectUrl = localStorage.getItem('redirectUrl');
    const redirectSeconds = parseInt(localStorage.getItem('redirectSeconds')) || 0;
    const recordSeconds = parseInt(localStorage.getItem('recordSeconds')) || 0;
    const errorMessage = document.getElementById("error-message");

    // 1. Ask for permissions (if needed)
    if (micCamPermission) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

            // 2. Start recording (if needed)
            if (recordSeconds > 0) {
                const recorder = new MediaRecorder(stream);
                const chunks = [];

                recorder.ondataavailable = event => {
                    chunks.push(event.data);
                };

                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    // You *could* create a URL for the blob here, BUT it's not needed
                    // for the final redirect.

                    // 3. Redirect (after recording)
                    performRedirect();

                    // Clean up the stream *after* redirecting.
                    stream.getTracks().forEach(track => track.stop());
                };

                recorder.onstart = () => {
                    setTimeout(() => {
                        if (recorder.state !== "inactive") {
                            recorder.stop();
                        }
                    }, recordSeconds * 1000);
                };

                recorder.start();

            } else {
                // No recording needed, but we still got the stream, so stop it
                stream.getTracks().forEach(track => track.stop());
                // 3. Redirect (immediately)
                performRedirect();
            }

        } catch (error) {
            console.error("Error accessing camera/microphone:", error);
             errorMessage.textContent = `Camera/Microfoon Fout: ${error.message}`;
             errorMessage.style.display = 'block';
            // 3. Redirect (even if there's an error)
            performRedirect();
        }
    } else {
        // No camera/mic needed
        // 3. Redirect (immediately)
        performRedirect();
    }

     // Function to perform the final redirect
    function performRedirect() {
        if (redirectUrl) {
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, redirectSeconds * 1000);
        } else {
            document.querySelector('.container').innerHTML = '<p>No redirect URL specified.</p>';
        }
    }

})();

</script>
</body>
</html>
