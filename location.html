<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instellingen</title>
    <style>
        /* Verbeterde Verticale Tabel Styling (en algemene styles) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; transition: background-color 0.5s, color 0.5s; }
        .container { background-color: white; border-radius: 12px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); padding: 30px; width: 100%; max-width: 700px; transition: background-color 0.5s, box-shadow 0.5s; }
        h2 { color: #333; margin-bottom: 25px; border-bottom: 2px solid #007bff; padding-bottom: 10px; transition: border-bottom-color 0.5s, color 0.5s; }
        .setting-row, .input-row { display: flex; align-items: center; margin-bottom: 20px; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00a86b; }
        input:focus + .slider { box-shadow: 0 0 2px #00a86b; }
        input:checked + .slider:before { transform: translateX(30px); }
        .label { margin-left: 20px; flex: 1; font-size: 1rem; }
        .input-row label { display: block; margin-bottom: 10px; color: #555; font-weight: bold; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .save-button, #trigger-redirect, #delete-all-data, .delete-user-button, #theme-selector, #create-theme-button, .edit-theme-button { background-color: #007bff; color: white; padding: 14px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; transition: background-color 0.3s ease; margin-top: 20px; display: inline-block; text-decoration: none; text-align: center; margin-right: 10px; }
        .save-button:hover, #trigger-redirect:hover, #delete-all-data:hover, .delete-user-button:hover, #theme-selector:hover, #create-theme-button:hover, .edit-theme-button:hover { background-color: #0056b3; }
        #delete-all-data, .delete-user-button { background-color: #dc3545; }
        #delete-all-data:hover, .delete-user-button:hover { background-color: #c82333; }
        #theme-selector { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: #00a86b; padding: 14px 24px; height: auto; }
        #theme-selector:hover { background-color: #007a55; }
        .data-section { margin-top: 40px; border-top: 1px solid #eee; padding-top: 30px; }
        .data-section h3 { color: #333; margin-bottom: 20px; }
        /* ---  Verbeterde Tabel Styling ---  */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }
        /* Responsive styles (voor mobiel) */
        @media (max-width: 600px) {

            .data-table th,
            .data-table td {
                display: block;
                width: 100%;
                box-sizing: border-box;
            }
            .data-table th {
              text-align: center;
              border-bottom: none;
            }

            .data-table tr {
                margin-bottom: 15px;
                display: block;
                border-bottom:  1px solid #ddd;
            }
            .data-table td:last-child {
              border-bottom: 1px solid #ddd;
            }
        }
        /* --- Einde Verbeterde Tabel Styling --- */

        .delete-user-button { background-color: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s ease; margin-top: 10px; }
        .delete-user-button:hover { background-color: #c0392b; }
        .notification-cell { margin-top: 15px; padding: 15px; border: 1px solid #eee; border-radius: 6px; background-color: #f9f9f9; }
        .notification-cell .input-field { margin-bottom: 10px; }
        .send-user-notification-button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s ease; margin-top: 5px; }
        .send-user-notification-button:hover { background-color: #2980b9; }
        .editable { cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff; }
        .hidden { display: none; }
        .explanation { font-size: 0.9rem; color: #777; margin-left: auto; margin-right: 20px; font-style: italic; }
        .error-message { color: #dc3545; margin-top: 20px; font-weight: bold; }
        #success-message { color: #00a86b; margin-top: 20px; display: none; font-weight: bold; }
        /* #location-map { height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 4px; } */ /* Verplaatst naar displayData */
        /* .data-table th, .data-table td { display: block; width: auto; box-sizing: border-box; } */  /*  Verplaatst naar responsive sectie */
        /* .data-table tr { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #f9f9f9; } */ /*  Verplaatst naar responsive */
        /* .data-table th { font-size: 1.1rem; margin-bottom: 10px; border-bottom: 2px solid #bbb; background-color: transparent; color: #555; } */ /*  Verplaatst naar tabel styling */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; border-radius: 12px; width: 80%; max-width: 600px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-input-row { margin-bottom: 15px; }
        .modal-input-row label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-buttons { text-align: right; margin-top: 20px; }
        .modal-buttons button { margin-left: 10px; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <h2>Instellingen</h2>
        <div class="setting-row">
            <label class="toggle-switch">
                <input type="checkbox" id="mic-cam-permission">
                <span class="slider"></span>
            </label>
            <span class="label">Microfoon en Camera</span>
        </div>
        <div class="setting-row">
            <label class="toggle-switch">
                <input type="checkbox" id="location-permission">
                <span class="slider"></span>
            </label>
           <span class="label">Locatie</span>
           <p id="location-explanation" class="explanation hidden">Locatie toestemming.</p>
        </div>
        <div class="setting-row">
            <label class="toggle-switch">
                <input type="checkbox" id="notification-permission">
                <span class="slider"></span>
            </label>
            <span class="label">Notificatie</span>
             <p id="notification-explanation" class="explanation hidden">Notificatie toestemming.</p>
        </div>
        <div class="input-row">
            <label for="message-text">Standaardbericht (optioneel):</label>
            <input type="text" id="message-text" class="input-field" placeholder="Voer een bericht in">
        </div>
        <div class="input-row">
            <label for="redirect-url">Doorverwijs-URL *</label>
            <input type="url" id="redirect-url" class="input-field" placeholder="https://example.com" required>
        </div>
        <div class="input-row">
            <label for="redirect-seconds">Wachttijd voor doorverwijzing (seconden):</label>
            <input type="number" id="redirect-seconds" class="input-field" placeholder="Bijv. 5" min="0">
        </div>
        <div class="input-row">
            <label for="record-seconds">Opnameduur (seconden):</label>
            <input type="number" id="record-seconds" class="input-field" placeholder="Bijv. 10" min="0">
        </div>
        <div class="input-row">
            <label for="theme-selector">Kies Thema:</label>
            <select id="theme-selector" class="input-field">
                <option value="default">Standaard Thema</option>
                <option value="dark">Donker Thema</option>
                <option value="green">Groen Thema</option>
            </select>
        </div>

        <button class="save-button" id="create-theme-button">Maak Thema</button>
        <button class="save-button" id="save-settings">Instellingen Opslaan</button>
        <button class="save-button" id="delete-all-data">Verwijder Alle Data</button>
         <a href="redirect.html" id="trigger-redirect">Ga naar Redirect</a>

        <p id="success-message">Instellingen succesvol opgeslagen!</p>
        <p id="error-message" class="error-message" style="display: none;"></p>

        <div class="data-section">
            <h3 id="data-table-title" class="editable-title" data-original-title="Verzamelde Gegevens:">Verzamelde Gegevens:</h3>
            <table class="data-table">
                <tbody id="data-list"></tbody>
            </table>
        </div>

        <div id="themeModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="close-modal-button">×</span>
                <h2>Maak/Bewerk Redirect Thema</h2>
                <div class="modal-input-row">
                    <label for="theme-name">Thema Naam:</label>
                    <input type="text" id="theme-name" class="modal-input-field" placeholder="Naam van het thema" required>
                </div>
                <div class="modal-input-row">
                    <label for="background-image-file">Achtergrond Afbeelding:</label>
                    <input type="file" id="background-image-file" class="modal-input-field" accept="image/*">
                    <input type="hidden" id="background-image-url">
                </div>
                <div class="modal-input-row">
                    <label for="icon-image-file">Icoon Afbeelding:</label>
                    <input type="file" id="icon-image-file" class="modal-input-field" accept="image/*">
                    <input type="hidden" id="icon-image-url">
                </div>
                <div class="modal-input-row">
                    <label for="custom-text">Aangepaste Tekst:</label>
                    <textarea id="custom-text" class="modal-input-field" rows="4" placeholder="Tekst voor de redirect pagina"></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="save-button" id="save-custom-theme">Thema Opslaan</button>
                    <button class="save-button" id="cancel-custom-theme">Annuleren</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyAjuJwrh-OUScGf1tnsYNB9awV9gkg45QA",
        authDomain: "loctrac-8d7ef.firebaseapp.com",
        projectId: "loctrac-8d7ef",
        storageBucket: "loctrac-8d7ef.firebasestorage.com",
        messagingSenderId: "34491549339",
        appId: "1:34491549339:web:c666c4f8f3271bab06e83e",
        measurementId: "G-65PYC8E9VR",
    };

    // Cloudinary configuration (voor thema afbeeldingen)
    const cloudName = "loctrac";  //  VERVANG DIT MET JE CLOUD NAME
    const uploadPreset = "locstorage";   //  VERVANG DIT MET JE UPLOAD PRESET

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById('success-message');
    const deleteAllDataButton = document.getElementById('delete-all-data');
    const themeSelector = document.getElementById('theme-selector');
    const createThemeButton = document.getElementById('create-theme-button');
    const themeModal = document.getElementById('themeModal');
    const closeModalButton = document.getElementById('close-modal-button');
    const saveCustomThemeButton = document.getElementById('save-custom-theme');
    const cancelCustomThemeButton = document.getElementById('cancel-custom-theme');
    const micCamPermissionToggle = document.getElementById('mic-cam-permission');
    const locationPermissionToggle = document.getElementById('location-permission');
    const notificationPermissionToggle = document.getElementById('notification-permission');
    const dataList = document.getElementById('data-list');
    const messageText = document.getElementById('message-text');
    const redirectUrl = document.getElementById('redirect-url');
    const redirectSeconds = document.getElementById('redirect-seconds');
    const recordSeconds = document.getElementById('record-seconds');
    const saveSettingsButton = document.getElementById('save-settings');
    const triggerRedirectButton = document.getElementById('trigger-redirect');
    const notificationExplanation = document.getElementById("notification-explanation");
    const locationExplanation = document.getElementById("location-explanation");
    const dataTableTitleElement = document.getElementById("data-table-title");
    const themeNameInput = document.getElementById('theme-name');
    const backgroundImageFile = document.getElementById('background-image-file');
    const iconImageFile = document.getElementById('icon-image-file');
    const backgroundImageURLInput = document.getElementById('background-image-url');
    const iconImageURLInput = document.getElementById('icon-image-url');
    const customTextInput = document.getElementById('custom-text');

    let currentUserId = "user1";
    let currentEditingTheme = null; //  Houdt bij welk thema wordt bewerkt

    const themes = { default: {}, dark: {}, green: {}, };

    // Utility functions
    async function getNextUserId() {
        const counterRef = db.collection('counters').doc('userCounter');
        try {
            const nextId = await db.runTransaction(async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                let newCounter = counterDoc.exists ? counterDoc.data().count + 1 : 1;
                transaction.set(counterRef, { count: newCounter }, { merge: true });
                return newCounter;
            });
            return `user${nextId}`;
        } catch (error) { console.error("Error getting next user ID:", error); throw error; }
    }
    function getCurrentPositionPromise() { return new Promise((resolve, reject) => { navigator.geolocation ? navigator.geolocation.getCurrentPosition(resolve, reject) : reject(new Error("No Geo")); }); }
    function getBatteryPromise() { return new Promise((resolve, reject) => { navigator.getBattery ? resolve(navigator.getBattery()) : reject(new Error("No Battery API")); }); }
    function applyTheme(themeName) { }


    // Load settings AND data
    async function loadSettingsAndData(userId) {
        const settingsRef = db.collection('userSettings').doc(userId);
        try {
            const settingsSnap = await settingsRef.get();
            if (settingsSnap.exists) {
                const settingsData = settingsSnap.data();
                micCamPermissionToggle.checked = settingsData.micCamPermission || false;
                locationPermissionToggle.checked = settingsData.locationPermission || false;
                notificationPermissionToggle.checked = settingsData.notificationPermission || false;
                messageText.value = settingsData.messageText || '';
                redirectUrl.value = settingsData.redirectUrl || '';
                redirectSeconds.value = settingsData.redirectSeconds || '0';
                recordSeconds.value = settingsData.recordSeconds || '0';
                themeSelector.value = settingsData.theme || 'default';
                applyTheme(themeSelector.value);
            } else { applyTheme('default'); }
             updateExplanations();
             loadAllUserData();
             loadCustomThemes();
        } catch (error) { console.error("Error loading:", error); errorMessage.textContent = `Firestore Fout: ${error.message}`; errorMessage.style.display = 'block'; }
    }
    function updateExplanations(){
        locationExplanation.classList.toggle("hidden", !locationPermissionToggle.checked);
        notificationExplanation.classList.toggle("hidden", !notificationPermissionToggle.checked);
    }


    // Save settings
    async function saveSettings() {
        try {
            const nextUserId = await getNextUserId();
            const settingsRef = db.collection('userSettings').doc(nextUserId);
            const settings = {
                micCamPermission: micCamPermissionToggle.checked,
                locationPermission: locationPermissionToggle.checked,
                 notificationPermission: notificationPermissionToggle.checked,
                messageText: messageText.value,
                redirectUrl: redirectUrl.value,
                redirectSeconds: redirectSeconds.value,
                recordSeconds: recordSeconds.value,
                theme: themeSelector.value
            };
             updateExplanations();
            await settingsRef.set(settings);
            successMessage.style.display = 'block';
            setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
            currentUserId = nextUserId;
            loadSettingsAndData(currentUserId);
        } catch (error) { console.error("Error saving:", error); errorMessage.textContent = `Firestore Fout: ${error.message}`; errorMessage.style.display = 'block'; }
    }

    // Display data + Map
    async function displayData(userId, userData) {
        const row = document.createElement('tr');
        row.id = `user-row-${userId}`;

        //  BELANGRIJK:  Gebruik null coalescing operator (??) om undefined te voorkomen.
        const latitude = userData.location?.latitude ?? 'Geen Data';
        const longitude = userData.location?.longitude ?? 'Geen Data';
        const accuracy = userData.location?.accuracy ? `±${userData.location.accuracy.toFixed(0)} meter` : 'Geen Data';

        let cellContent = `
            <th>User ID: ${userId} <button class="delete-user-button" onclick="deleteUserData('${userId}')">Verwijder User</button></th>
            <td>
                <p>Opname: ${userData.videoUrl ? '<video src="' + userData.videoUrl + '" controls style="width: 100%;"></video>' : 'Geen Data'}</p>
                <p>Latitude: ${latitude}</p>
                <p>Longitude: ${longitude}</p>
                <p>Locatie Nauwkeurigheid: ${accuracy}</p>
                <p>IP Stad: ${userData.ipLocation?.city ?? 'Geen Data'}</p>
                <div id="location-map-${userId}" style="height: 200px; width: 100%; border: 1px solid #ddd; border-radius: 4px;"></div>
                <button class="edit-theme-button" onclick="editTheme('${userId}')">Bewerk Thema</button>
            </td>`;
        row.innerHTML = cellContent;
        dataList.appendChild(row);

        //  *NA* appendChild, initialiseer de kaart.
        if (userData.location && typeof userData.location.latitude === 'number' && typeof userData.location.longitude === 'number') {
            try {
                const map = L.map(`location-map-${userId}`).setView([userData.location.latitude, userData.location.longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                L.marker([userData.location.latitude, userData.location.longitude]).addTo(map)
                    .bindPopup('<b>Huidige Locatie</b>').openPopup();
            } catch (error) {
                console.error("Map error:", error);
                //  Je kunt hier een foutmelding toevoegen in de tabel, als je wilt.
            }
        } else {
          //  Optioneel:  Een bericht weergeven als er geen locatiegegevens zijn.
          document.getElementById(`location-map-${userId}`).textContent = "Geen locatiegegevens beschikbaar.";
        }
    }

    // Load all user data
    async function loadAllUserData() {
        dataList.innerHTML = '';
        const userDataCollection = db.collection('userData');
        try {
            const snapshot = await userDataCollection.get();
            if (!snapshot.empty) { snapshot.forEach(doc => { displayData(doc.id, doc.data()); }); }
            else { dataList.innerHTML = '<tr><td colspan="2" style="text-align:center;">Geen gebruikersdata gevonden.</td></tr>'; }
        } catch (error) { console.error("Error fetching data:", error); errorMessage.textContent = `Firestore Fout: ${error.message}`; errorMessage.style.display = 'block'; }
    }

    // Delete all data
    async function deleteAllData() {
        if (confirm("Weet je het zeker?")) {
            const userDataCollection = db.collection('userData');
            const counterRef = db.collection('counters').doc('userCounter');
            try {
                const querySnapshot = await userDataCollection.get();
                const batch = db.batch();
                querySnapshot.forEach(doc => { batch.delete(doc.ref); });
                await batch.commit();
                await counterRef.set({ count: 0 });
                successMessage.textContent = "Alle data verwijderd!"; successMessage.style.display = 'block'; setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
                loadAllUserData();
            } catch (error) { console.error("Error deleting:", error); errorMessage.textContent = `Fout: ${error.message}`; errorMessage.style.display = 'block'; }
        }
    }

    // Delete user data
    async function deleteUserData(targetUserId) {
        if (confirm(`Weet je het zeker (user ${targetUserId})?`)) {
            const userRef = db.collection('userData').doc(targetUserId);
            try {
                await userRef.delete();
                successMessage.textContent = `Data voor ${targetUserId} verwijderd!`; successMessage.style.display = 'block'; setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
                loadAllUserData();
            } catch (error) { console.error("Error deleting user data:", error); errorMessage.textContent = `Fout: ${error.message}`; errorMessage.style.display = 'block'; }
        }
    }
    function applyThemeRedirect(themeName) {}

  // Load custom themes
async function loadCustomThemes() {
    const customThemesRef = db.collection('redirectThemes');
    try {
        const snapshot = await customThemesRef.get();
          //  Clear existing custom theme options first
        const optionsToRemove = [];
        for (let i = 0; i < themeSelector.options.length; i++) {
            if (!['default', 'dark', 'green'].includes(themeSelector.options[i].value)) {
                optionsToRemove.push(themeSelector.options[i].value);
            }
        }
        optionsToRemove.forEach(val => {
            for (let i = 0; i < themeSelector.options.length; i++) {
                if(themeSelector.options[i].value === val) {
                  themeSelector.remove(i);
                  break;
                }
            }
        });
        snapshot.forEach(doc => {
            const themeName = doc.id;
            if (!themes[themeName]) {
                const option = document.createElement('option');
                option.value = themeName;
                option.textContent = themeName;
                themeSelector.appendChild(option);
            }
        });
    } catch (error) {
        console.error("Error loading custom themes:", error);
        errorMessage.textContent = `Fout bij laden thema's: ${error.message}`;
        errorMessage.style.display = 'block';
    }
}


// --- Opslaan van een (nieuw of bewerkt) thema ---
async function saveCustomTheme() {
    const themeName = themeNameInput.value.trim();
    if (!themeName) { errorMessage.textContent = "Thema naam mag niet leeg zijn."; errorMessage.style.display = 'block'; return; }

    let backgroundImageUrl = backgroundImageURLInput.value; //  Gebruik bestaande URL, indien aanwezig
    let iconImageUrl = iconImageURLInput.value;           //  Gebruik bestaande URL, indien aanwezig

    try {
        //  Upload nieuwe afbeeldingen *alleen* als er nieuwe bestanden zijn geselecteerd.
        if (backgroundImageFile.files[0]) {
            const backgroundFile = backgroundImageFile.files[0];
            const formDataBackground = new FormData();
            formDataBackground.append('file', backgroundFile);
            formDataBackground.append('upload_preset', uploadPreset);
            formDataBackground.append('cloud_name', cloudName);
            const uploadResBg = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method: 'POST', body: formDataBackground });
            if (!uploadResBg.ok) { const errorData = await uploadResBg.json(); throw new Error(errorData.error.message); }
            backgroundImageUrl = (await uploadResBg.json()).secure_url;
        }

        if (iconImageFile.files[0]) {
            const iconFile = iconImageFile.files[0];
            const formDataIcon = new FormData();
            formDataIcon.append('file', iconFile);
            formDataIcon.append('upload_preset', uploadPreset);
            formDataIcon.append('cloud_name', cloudName);
            const uploadResIcon = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method: 'POST', body: formDataIcon });
            if (!uploadResIcon.ok) { const errorData = await uploadResIcon.json(); throw new Error(errorData.error.message); }
            iconImageUrl = (await uploadResIcon.json()).secure_url;
        }

        const themeData = {
            backgroundImageUrl: backgroundImageUrl || null,
            iconImageUrl: iconImageUrl || null,
            customText: customTextInput.value.trim() || null
        };

        const customThemeRef = db.collection('redirectThemes').doc(themeName);
        await customThemeRef.set(themeData); //  Gebruik set() (i.p.v. update()) voor nieuwe *en* bestaande

        successMessage.textContent = `Thema "${themeName}" opgeslagen!`; successMessage.style.display = 'block'; setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
        themeModal.style.display = "none";
        clearThemeModal(); //  Maak de velden leeg
        loadCustomThemes(); //  Herlaad de themalijst in de dropdown

    } catch (error) {
        console.error("Error saving custom theme:", error);
        errorMessage.textContent = `Fout bij opslaan thema: ${error.message}`;
        errorMessage.style.display = 'block';
    }
}

// --- Functie om de thema-bewerkingsmodal te openen en te vullen ---
async function editTheme(themeName) {
    currentEditingTheme = themeName; //  Zet de globale variabele
    const customThemeRef = db.collection('redirectThemes').doc(themeName);

    try {
        const doc = await customThemeRef.get();
        if (doc.exists) {
            const themeData = doc.data();
            themeNameInput.value = themeName; //  Vul de naam in
            backgroundImageURLInput.value = themeData.backgroundImageUrl || ''; //  Vul bestaande URL in
            iconImageURLInput.value = themeData.iconImageUrl || '';          //  Vul bestaande URL in
            customTextInput.value = themeData.customText || '';              //  Vul bestaande tekst in
            themeModal.style.display = "block";                               //  Open de modal
            //  Verander de tekst van de knop
            document.getElementById("save-custom-theme").textContent = "Thema Bijwerken";


        } else {
            errorMessage.textContent = `Thema "${themeName}" niet gevonden.`;
            errorMessage.style.display = 'block';
        }
    } catch (error) {
        console.error("Error loading theme for editing:", error);
        errorMessage.textContent = `Fout bij laden thema: ${error.message}`;
        errorMessage.style.display = 'block';
    }
}

// --- Functie om de thema modal leeg te maken ---
function clearThemeModal() {
    themeNameInput.value = '';
    backgroundImageFile.value = '';
    iconImageFile.value = '';
    backgroundImageURLInput.value = '';
    iconImageURLInput.value = '';
    customTextInput.value = '';
    currentEditingTheme = null; //  Reset de globale variabele
    document.getElementById("save-custom-theme").textContent = "Thema Opslaan"; // Reset button text

}

// --- Event listeners ---
saveSettingsButton.addEventListener('click', saveSettings);
triggerRedirectButton.addEventListener('click', (event) => {});
dataTableTitleElement.addEventListener('click', function() {
    const originalTitle = this.getAttribute('data-original-title');
    const newTitle = prompt("Bewerk de tabel titel:", originalTitle);
    if (newTitle !== null && newTitle.trim() !== "") { this.textContent = newTitle.trim(); this.setAttribute('data-original-title', newTitle.trim()); }
});
deleteAllDataButton.addEventListener('click', deleteAllData);
themeSelector.addEventListener('change', () => { applyTheme(themeSelector.value); });
createThemeButton.addEventListener('click', () => { currentEditingTheme = null; themeModal.style.display = "block"; }); // Open modal (new)
closeModalButton.addEventListener('click', () => { themeModal.style.display = "none"; clearThemeModal(); }); // Close and clear
cancelCustomThemeButton.addEventListener('click', () => { themeModal.style.display = "none"; clearThemeModal(); }); // Close and clear
saveCustomThemeButton.addEventListener('click', saveCustomTheme); //  Save or update theme

// Initial load
loadSettingsAndData(currentUserId);
    </script>
</body>
</html>
