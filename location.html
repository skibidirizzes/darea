<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opgeslagen Locaties</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            background: url('https://i.postimg.cc/sDTjTFrr/whatsapp-background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #333;
        }

        .location-item {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.8);
            position: relative;
        }

        .location-map {
            height: 200px;
            width: 100%;
            margin-top: 10px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            cursor: pointer;
        }

        .edit-input {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .edit-input input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .edit-input button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .edit-input button:hover {
            background: #45a049;
        }

        /* Schakelaar */
        label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Opgeslagen Locaties</h1>

    <!-- On/Off schakelaar -->
    <label>
        <input type="checkbox" id="locationSwitch" />
        Locatie toestemming inschakelen
    </label>

    <div id="saved-locations"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // On/Off switch functionaliteit
        const locationSwitch = document.getElementById("locationSwitch");

        // Lees de status van de switch bij het laden van de pagina
        const locationEnabled = localStorage.getItem("locationEnabled") === "true";
        locationSwitch.checked = locationEnabled;

        // Schakel de status in of uit
        locationSwitch.addEventListener("change", () => {
            localStorage.setItem("locationEnabled", locationSwitch.checked);
            alert(`Locatie toestemming is nu ${locationSwitch.checked ? "ingeschakeld" : "uitgeschakeld"}.`);
        });

        // Groepeer locaties op basis van apparaat en locatie
        function groupLocations(locations) {
            const grouped = {};

            locations.forEach((loc) => {
                const key = `${loc.lat}-${loc.lon}-${loc.device}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        lat: loc.lat,
                        lon: loc.lon,
                        device: loc.device,
                        accuracy: loc.accuracy,
                        title: loc.title || "Locatie",
                        battery: loc.battery,
                        times: []
                    };
                }
                grouped[key].times.push(loc.timestamp);
            });

            return Object.values(grouped);
        }

        function deleteLocation(index) {
            let savedLocations = JSON.parse(localStorage.getItem("locations")) || [];
            savedLocations.splice(index, 1);
            localStorage.setItem("locations", JSON.stringify(savedLocations));
            displaySavedLocations();
        }

        function updateLocationTitle(index, newTitle) {
            let savedLocations = JSON.parse(localStorage.getItem("locations")) || [];
            savedLocations[index].title = newTitle.trim() || "Locatie";
            localStorage.setItem("locations", JSON.stringify(savedLocations));
            displaySavedLocations();
        }

        async function displaySavedLocations() {
            const savedLocations = JSON.parse(localStorage.getItem("locations")) || [];
            const container = document.getElementById("saved-locations");
            container.innerHTML = "";

            if (savedLocations.length === 0) {
                container.innerHTML = "<p>Geen opgeslagen locaties gevonden.</p>";
                return;
            }

            const groupedLocations = groupLocations(savedLocations);

            groupedLocations.forEach((location, groupIndex) => {
                const locationItem = document.createElement("div");
                locationItem.classList.add("location-item");

                const closeButton = document.createElement("button");
                closeButton.classList.add("close-btn");
                closeButton.innerText = "X";
                closeButton.onclick = () => deleteLocation(groupIndex);

                locationItem.innerHTML = `
                    <p><strong><span id="title-${groupIndex}">${location.title}</span></strong></p>
                    <p>Breedtegraad: ${location.lat}</p>
                    <p>Lengtegraad: ${location.lon}</p>
                    <p>Nauwkeurigheid: ±${location.accuracy} meter</p>
                    <p>Batterijniveau: ${location.battery?.level || "Onbekend"}</p>
                    <p>Opladen: ${location.battery?.charging || "Onbekend"}</p>
                    <p>Apparaat: ${location.device}</p>
                    <p><strong>Aantal Bezoeken:</strong> ${location.times.length}</p>
                    <p><strong>Tijden:</strong></p>
                    <ul>
                        ${location.times.map((time) => `<li>${time}</li>`).join("")}
                    </ul>
                    <div id="map-${groupIndex}" class="location-map"></div>
                `;

                const editInput = document.createElement("div");
                editInput.classList.add("edit-input");
                editInput.innerHTML = `
                    <input type="text" placeholder="Wijzig titel" id="edit-title-${groupIndex}">
                    <button onclick="updateLocationTitle(${groupIndex}, document.getElementById('edit-title-${groupIndex}').value)">Opslaan</button>
                `;

                locationItem.appendChild(editInput);
                locationItem.appendChild(closeButton);
                container.appendChild(locationItem);

                const map = L.map(`map-${groupIndex}`).setView([location.lat, location.lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                L.marker([location.lat, location.lon]).addTo(map).bindPopup(`<strong>${location.title}</strong>`);
            });
        }

        async function initializeBatteryStatus() {
            const batteryStatus = await navigator.getBattery?.();
            const battery = batteryStatus
                ? {
                      level: Math.round(batteryStatus.level * 100) + '%',
                      charging: batteryStatus.charging ? 'Ja' : 'Nee',
                  }
                : { level: 'Onbekend', charging: 'Onbekend' };

            const savedLocations = JSON.parse(localStorage.getItem("locations")) || [];
            const updatedLocations = savedLocations.map((location) => ({
                ...location,
                battery: battery,
            }));

            localStorage.setItem("locations", JSON.stringify(updatedLocations));
            displaySavedLocations();
        }

        initializeBatteryStatus();
    </script>
</body>
</html>
